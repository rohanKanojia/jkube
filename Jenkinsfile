#!groovy

pipeline {
  agent any
  tools {
    maven 'apache-maven-latest'
    jdk 'adoptopenjdk-hotspot-jdk8-latest'
  }
  stages {
    stage('Build') {
        steps {
            sh '''
                GPG_KEY=LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tCgptUUlOQkYzMzBjOEJFQUNlaTJSQmN0MTFxY0pSVnc0N3ZyamlzTzNKSSt0QTFJdEJGSEpZS0xGb2ZKUEliRjhSCmVaQlpkTTdrM0pVbFBPbE5WWGw3WXlUK3daaG52cXJzMFdFS2RDVU1GbW1YamtVYXN4MW54UzlodDdQd2Nzb1kKbkFOUDJML1RTbjJLcWRmcFQxTE5tV2FMZzhIUG5iR2hzZWdyRXd2NlVhNW5ZeFdneithUUJLNjFiLytrd1ZDMApuT1VDUWlhVmExd0lxVlJidE5xc01lS2FwcCtEbHVNaVZlWHBpVXZFTXcyQ2hnSnRrTWtsSlhXZHRjcUxjVkdtCmZuSzE5dURJZVpjdVh0Yno0RUphV0lCOVdDRzlkNFhCcFR0RWpnWjhhVHlPbk9zbDdIcW9pdTNTcXJxWnVCdFIKRE83S2VTUmtwVzlVYlJiNHRhQ1lvc29DM21KaE50MzFRY0VSSjJwQ0tTV29iK2F5SmpCV25wOTkwYklEcXlhTAowU2V0OFpYMmZUSnJYK3V5aUtYNjRlQlRoMzlSSkQzQ1Y4cCtkbXpYTmFWRjZJRDlRTG1MbTZwdmFUYzBSa2t6Ci9OMkE1UWlPbEkydUVuT21Vei9CZWRYNEVZdEt3MG5hN1N4L1ZudGlRQVdEbWcrZGJWQndaaFlqUTViem4yVkgKdG92WXYvdnVKcnl4Mnp3NEJsQ0pQMnVyK2lqeWhIWDdkbXVyZzl6ajdsTDFOdGx2dlEweUJyZEZPZGxBTUowNwo0ZFF4dHJTVzVadm05Ty9nUnpRRWhBZGdCWE8xWkNKTmVoTjN3WUIrSVNIL3YyZXRMejRLbnh0Q0ROSDU0TGJQCkNnd2pDVGxFRWxuVDR1NEJwelpNNGdEakkxUjNqQit3bCtTTUR6UW9Ta0VZYmg2cm4wWVlyRHEzOVFBUkFRQUIKdEN4RlkyeHBjSE5sSUVwcmRXSmxJRUp2ZENBOFpXTnNhWEJ6WldwcmRXSmxRR1ZqYkdsd2MyVXViM0puUG9rQwpUZ1FUQVFnQU9CWWhCQXliNUxlZ1k3dk5tY3QyaGZhQ1VFR2lNcXczQlFKZDk5SFBBaHNEQlFzSkNBY0NCaFVLCkNRZ0xBZ1FXQWdNQkFoNEJBaGVBQUFvSkVQYUNVRUdpTXF3M1VjQVAvMzE5R0ZOeUwxb3Y3dWR5ckdPNmFFWVQKcFhnR3hYeFRSNzAyU01LSDFhNlBETSsxRUkyanNsQURObEdRSWZoZkpySGdqQVlvV1ZHS014VTVJVWxteHVnbQpYb3NsaFZsYyt0Wk9QMDAxUmhpYVNzYkpqSnluYVVVRXdEa1cyRzBGRG5JeUtTRUZWQ0MzQ3N6YkJZMThjL0UyCm9YS0dMQ0VhS0d1NTArdFFwc0Eyd25nWDc4NmtmNHUyNmdFcjNERU1JV3VIeE1FNDN5SkJ0Sk5wVWlQb0laMWoKVy90WGdoVjFSalRkYnNHKzZNVjZ6eHJVMjJoMjRRRmxYL1VHUmJnWVI0b2tuckFrQTZ2S3VzQTR3bUhaVnhQKwpXVUZsV3hNa2dZbUdtUkdKNTNjTWdQM1J6ME1Hck1CdlVMODJWMGFTMGVvWFVFUUhaNC84dFh2aDZya2JaV1RSCkd3ejRUZUhYbkgxc0QwYU9RYTNLcHprOEFadGd4anJBWDhkWEVyVlZhdnZlK0lXTWw1elpFMTVDejR1UDZ3WTIKY1JTMEFtN3l0M1FVcXFWYk80YVQxS3hkTUxFM2Fzb2dhV053TXRDanJycWc3Smx4NUhsZ0VncC9EVXBzQnZFOApGQ3FMM0lKRVJyV3VLaVlubCtLRXNxcE1ZbGFuSzhOSFFKOWVYK3FXSm9tYktqd2h4K0pqZXpHbkl5MWdSYXBkCklWSlkrYXh6aVYySEJMcnZJYlBpaUZ0R3BNQisxZXZPS3djWUJ5YXBXNVI3TFlFS2tRQmpxOC9FL0RUZlN0NnQKQWJ4Vm9JdUQyc2I1ZkdiUGNpbnYyYWZZU0VDeWlBRzZTeEh5OTFCcHRpZlhoMnkxY3h5SGJnWC9OWlZhMC9xSwo2SDhRQm9XRjlRUmxqbm5oTzVtRnVRSU5CRjMzMGM4QkVBQ2pLS1dnakpzMWJpY3lpQUtqeGd3OEVodlNQS1BCClBYSDQ0N0NmZTJ5b0hkdVpCQkh4dGR6OE1kQ1huK245OVBxeTNwZ29HaTlhb2FmUVo2djNQd1JVb29POWJweVUKY3pCcXFpeWRyUUhaZ2ozMFRhdyttb0ZGM2sycHFFV3duSXNFYk9NS3NuaTFJWXpuaDhjNWVYM1hSY2gvTWRTVApYem1LaXZHRG1UZ2c3Z2ZYL2xqQ0t5QmVUOU40eDg1djJGRGRXQ05Od0g3bks2TWdQcXRVYVYzbm8wdVhGKzk0CnpyaGZMNHdzU1BvYlNtaVZkaGRnM09BbTE1a0FSa2FJSzFtTmhMS2E3ZXFCRVEwdGRBRVhMck5TdU8yVzJQNXEKWkxHNGRieTlLT2pjWHFqT3hYTlllWk42TmdFTlZSVVl0TnZHSUxVN0U2alpTYzBVWGFtMnB2Q1FtdWVFWW5IUwo3OG1UWW9rRFVGYkNCOTA0UkM1ZFBwUGo3Z1lPMThwVFhrYXZSNUlNMzBSUDEwSmJ0V21vQXozZzdqc2pkQVN3ClA3U0gzeVZGeUdBQ0ZkZCtaNm16WC90MDg4ZlhkS1hLZXBVZ0JJZ2V6SU51eGk5Snc1VXY4cm40UUlBdDg1QzcKRFpqTVRKRGhYZHlqanlzdFFEWEUvUFU1M2lrUVdxeFRLUXRpMFRoUXNUSlVIMzVxdjJWY3dGVVR2M3I3bjJYOQpFUUluMFR4aU1DVzBOalY2MTJxTkxDWnhpdTdQa0ZDb2hnT1RpK245MTJPY2xtalprNzVNU3pxUHhKRHdWNy9LClNuRENOeGRFdThUR0F0MEI2T1JZQ3pxb1FLNi9USU8zWGw1M2VIY1dQUm5IMm5sNnozY0NKc0ZneHJHeWtNL1IKZ1FXRFYweTdLRlJGdFFBUkFRQUJpUUkyQkJnQkNBQWdGaUVFREp2a3Q2Qmp1ODJaeTNhRjlvSlFRYUl5ckRjRgpBbDMzMGM4Q0d3d0FDZ2tROW9KUVFhSXlyRGMzSHcvL1JHL2U2a3NlUG43RENXcWVYR25MU3A5NDBrVm02aGoxCkRYZmIvVU9ncS9MMWxBQ3pTM1oydWtldEcyUFV5OE5XLzB6VUlzSUpuSnluTWQ2NHp6cjJZclJZZTRCclc4T3EKZ0J4RmNFWmttN1JzaFFQUU54RXpVTVJ4R1QrMGpMUWpYUFh6Z09Fdk9XQUpGbC9nOHdueU1VZDhCbjJ3cTY5cgpxZnRTbENLQ0x6Y1JqU251aEZBZDBlMWQ0b2pQc0ZGUktSek5jODBYdUFDdWJNYUtyZ3JYb0hxNWV1RWJ0Q0pMCjlSSXZNTnBDaklkQlNRV2cxbmtMVjBoQjJ2QzVkSGR5a081MDkxdHlBeG44aWxxQk50T0RMMkI3MTAzWjhXb3cKdXp4WlBhK0dlZWpBKzFKbWdMK3VuYzRyY0VTWUxRdko1OE51TXBIUXBwcUhlK0Y3Qis3cmo4YmVrTHZ4MDM1ZApjWTdCY3hzY2VoLzdUN09VRitBSXVpZkVmM3JyOGRIVDBackFFU05lOVcxS1MxQXZYcHJQKzVpVzcrQVZrbDJvCldGL0s4UHREckZTNUUzTHM4R0RiU0l5NmRWMjVwa1cxUlNFY3JOK2tMcjA0ejNCNFNLYW1LaVZEbXEySTMwWEoKRmkyOTErOCtyYXVrK3B1bGxHa2J1ZGRpdjRsRzVvYlBlNlBEMGRBN2ZzSWpjUVgrWTIyL015aVozeit0MTJtcwp3RjhUWFJDNFRvWmtuZlhWVmZkUjJNdTVtVjdDWGtJbDVtL3VmOTNoNUwxeW9BUmhNY2pTeVhkaFZvN1BxQ2FrCllPdFMwYnNrSFhWVU5YWmRRbVZkZEdzVGx1WThYOWEyNUZsbzBRL0NRZXVWUys2WkpjUWtkSjV2UW1EckxBcEcKUlFISCtBVnVsanM9Cj1VbGxCCi0tLS0tRU5EIFBHUCBQVUJMSUMgS0VZIEJMT0NLLS0tLS0=
                echo $GPG_KEY | base64 --decode > $HOME/eclipsejkubekey.asc
                gpg --import $HOME/eclipsejkubekey.asc
                HEAD=$(git log -1 --format=format:%H)
                RELEASE_VERSION=$(git tag --points-at $HEAD)
                if test -z "$RELEASE_VERSION"; then
                    echo "No release version specified"
                    exit 1
                fi
                echo 'starting release with version $RELEASE_VERSION'
                mvn versions:set -DnewVersion=$RELEASE_VERSION
                mvn clean -B
                # read repo_id from *.properties file and set it
                repo_id=$(cat target/nexus-staging/staging/*.properties | grep id | awk -F'=' '{print $2}')
mvn -B org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:rc-release -DserverId=oss-sonatype-staging -DnexusUrl=https://oss.sonatype.org -DstagingRepositoryId=${repo_id} -Ddescription=\"Next release is ready\" -DstagingProgressTimeoutMinutes=60

                '''
        }
    }
  }
}
